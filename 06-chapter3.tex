\chapter{РАЗРАБОТКА И ТЕСТИРОВАНИЕ}
\aftertitle

\section{Выбор стека технологий}

Перед началом разработки системы анализа новостей был произведен анализ различных технологий и выбор стека технологий для разработки сервиса. Выбор основного компонента сервиса ~-- векторной базы данных ~-- был осуществлен в главе \ref{chap:arch_design}.

\subsection{Выбор языка программирования}

В качестве языка программирования для разработки системы анализа новостей был выбран Python. Выбор Python в качестве основного языка программирования для разработки системы анализа новостей обусловлен несколькими важными причинами.

Python является лидирующим языком в области науки о данных и машинного обучения. Большинство библиотек для этих задач написаны на Python или имеют привязки к нему.

Python является простым и высокоуровневым языком, который позволяет разрабатывать сложные системы, затрачивая меньше усилий, по сравнению со многими другими языками. : Python отличается от других языков своей простотой и читаемостью. Это ускоряет процесс разработки, облегчает отладку и поддержку кода.

Векторная база данных Weaviate, которая используется в этом проекте, имеет официальную клиентскую библиотеку для Python. Это обеспечивает удобный и надежный доступ к функциям базы данных.

Python имеет множество фреймворков для разработки веб-сервисов, таких как FastAPI, Flask и Django, что делает его идеальным выбором для создания веб-сервиса, предусмотренного в этом проекте.

\subsection{Выбор фреймворка для создания REST API}

Для реализации веб-сервиса нужно выбрать какой-либо фреймворк для разработки веб-приложений. В данной работе необходимо реализовать RESTful-сервис. Были сформулированы следующие требования к фреймворку:
\begin{itemize}
    \item поддержка реализации REST API;
    \item простота разработки и минимальное количество шаблонного кода;
    \item поддержка валидации входящих данных;
    \item поддержка создания документации в формате swagger.
\end{itemize}


Выбор подходящего фреймворка для реализации REST API в веб-сервисе зависит от многих факторов. Были рассмотрены преимущества и недостатки Django, Flask и FastAPI для данного проекта.

Django ~-- это высокоуровневый фреймворк разработки веб-приложений на Python, который обеспечивает полный набор функциональности "из коробки". Django предлагает ряд модулей для различных задач, включая аутентификацию, формы, маршрутизацию, управление сессиями и взаимодействие с базами данных. Django следует принципу DRY (Don't Repeat Yourself) и призывает к максимальному повторному использованию кода.

Преимущества:
\begin{itemize}
    \item обширная функциональность: Django имеет встроенные модули для работы с базами данных, административную панель, систему шаблонов и многое другое, что позволяет сократить время разработки;
    \item большое сообщество пользователей, что позволяет получить поддержку и множество ресурсов для изучения.
\end{itemize}

Недостатки:
\begin{itemize}
    \item избыточность: Django ~-- фреймворк, предназначенный для создания крупных веб-приложений со множеством функций, которые избыточны для REST сервиса;
    \item отсутствие некоторых функций для работы с REST API, таких как поддержки валидации данных и автоматической генерации документации Swagger.
\end{itemize}

Flask ~-- это фреймворк для разработки веб-приложений на Python. Он предназначен для создания небольших и простых веб-сайтов и API. В отличие от Django, Flask не предлагает множество функций "из коробки", но предоставляет основу, на которой можно строить, используя расширения. Flask предлагает больше гибкости, позволяя разработчикам выбирать инструменты и библиотеки, которые они хотят использовать.

Преимущества:
\begin{itemize}
    \item гибкость и модульность: Flask позволяет выбирать и использовать только те компоненты, которые действительно необходимы для проекта;
    \item простота использования: Flask легко изучить и начать использовать, особенно для небольших проектов.
\end{itemize}

Недостатки:
\begin{itemize}
    \item при создании REST API с Flask может потребоваться больше шаблонного кода по сравнению с другими фреймворками.
    \item отсутствие встроенной валидации данных, что может усложнить процесс разработки REST API.
\end{itemize}

FastAPI ~-- это современный, высокопроизводительный веб-фреймворк для построения API с Python. Он обеспечивает автоматическую генерацию документации для API, валидацию данных с помощью Python Type Hints и поддерживает асинхронные запросы. FastAPI был разработан с упором на удобство использования и производительность.

Преимущества:
\begin{itemize}
    \item FastAPI обеспечивает высокую производительность.
    \item встроенная валидация данных: FastAPI поддерживает валидацию данных на основе Python type hints, что облегчает проверку входящих данных.
    \item автоматическая генерация документации Swagger: FastAPI автоматически генерирует документацию Swagger на основе кода, что облегчает создание и поддержку документации API.
\end{itemize}

Недостатки:
\begin{itemize}
    \item FastAPI наименее популярный фреймворк, имеющий меньшее количество обучающих материалов.
\end{itemize}

Исходя из рассмотренных преимуществ и недостатков, для разработки проекта был выбран фреймоврк FastAPI. Он обеспечивает быстродействие и простоту использования, встроенную валидацию данных и генерацию документации Swagger, что полностью соответствует требованиям к фреймворку для этого проекта.

\section{Разработка системы добавления данных в векторную БД}

С помощью парсера новостные данные собираются и сохраняются в базе данных SQLite. Чтобы работать с ними, их необходимо проанализировать, очистить от выбросов и добавить в векторную базу данных Weaviate.

Были разработаны скрипты: скрипт для анализа и предобработки данных и скритпт для добавления новостей в Weaviate.

Для анализа и предобработки данных использовался язык программирования Python и библиотеки pandas, numpy и matplotlib. Это широко распространенные инструменты, применяемые в Data Science и при работе с данными, которые позволяют быстро выполнять множество различных операций, связанных с анализом и предобработкой данных.

В первую очередь, требуется определить временные рамки собранных новостей. В рамках работы, были собраны новости с 2019-04-23 по 2020-12-07. Т.к. собрано небольшое количество данных с новостных лент, то не представляет трудностей считать все данные в оперативную память и удобным образом работать с ними, используя средства библиотеки pandas, такие как DataFrame.

Следующим этапом предобработки является определение количества новостей за каждый день. Это позволит выявить ошибки и аномалии в данных.  До определенной даты, количество новостей существенно меньше, чем после этой даты. Изначально собиралось по несколько новостей, максимум, десятков новостей в день. Затем собирались от тысячи до двух тысяч новостей в день. Такая большая разница в количестве новостей в день может привести в дальнейшем к нарушению работы алгоритмов машинного обучения и к проблемам в определении корреляции новостей и тех или иных данных. Поэтому в рамках предобработки данных, необходимо удалить данные о новостях, относящиеся к периоду, в течении которого собиралось мало новостей в день

Обработанные данные сохранялись в промежуточный файл CSV.

Следующим этапом, эти данные из CSV файла считываются и добавляются в Weaviate. Предварительно, удаляется схема данных и все данные, чтобы избежать дублирования при повторном выполнении скрипта. Затем происходит создание схемы данных согласно \ref{chap:data-scheme}. После этого осуществляется последовательное добавление всех новостей в базу данных. Этот процесс занимает продолжительное время, потому что в момент добавления записей в базу происходит их векторизация с помощью указанного векторизатора (tex2vec-transformers с моделью MiniLM) и сохранение полученных векторов в базе.

Для работы с базой данных использовался официальная библиотека Weaviate для Python. Эта библиотека позволяет использовать все возможности базы данных, отправлять запросы на получение и модификацию данных с помощью Python без необходимости вручную работать с HTTP запросами REST и GraphQL.

\section{Разработка сервиса}

Для упрощения разработки и поддержки, весь код проекта разбит на модули. В процессе разработки сервиса была создана следующая структура файлов.
\begin{lstlisting}
service/
|-- app/
|-- scripts/
|-- main.py
\end{lstlisting}

В директории app находятся основные модули проекта. В директории scripts находятся вспомогательные скрипты, такие как скрипт добавления данных в базу данных Weaviate. Файл main.py является точкой входа в приложение, реализующей REST API с помощью фреймворка FastAPI. В main.py происходит обработка запросов, а основная логика выполнения запроса, например, обращение к БД, расчёт корреляции и т.п. осуществляется модулями из директории app.

Далее приведен пример обработки запроса поиска новостей с помощью семантического поиска:
\begin{lstlisting}
@app.get('/news')
def search_news(q: str):
    news = news_search.by_query(q)
    response = {
        'news': news
    }
    return response
\end{lstlisting}

С помощью декоратора определяется HTTP метод и URL конечной точки API, в данном случае, это GET и адрес "/news". Данная функция будет вызвана при получении соответствующего запроса. Параметры функции определяют параметры HTTP запроса. С помощью python type hints указывается тип параметра q: строка. В обработчике запроса происходит вызов функции семантического поиска новостей news\_search.by\_query(), которая возвращает список новостей, полученных из БД, близких к указанному запросу. Затем происходит формирование структуры и возврат ответа. FastAPI автоматически преобразует объект словаря в JSON и отправляет ответ пользователю.

\subsection{Разработка расчёта корреляции}

TODO: Написать про разработку механизма расчета корреляции

\subsection{Разработка метода определения основных новостей}

TODO: Написать про разработку кластеризации новостей для определения основных тем в заданном промежутке времени.


\section{Развертывание}

TODO: Написать про Docker


> Для упрощения развертывания сервиса на узлах вычислительного кластера, применяются Docker контейнеры. Основные компоненты системы: Weaviate, модуль векторизации Weaviate и сервис развернуты в отдельных Docker-контейнерах.
